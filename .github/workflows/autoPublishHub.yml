name: 打包并生成Docker镜像
on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
jobs:
  package-and-make-image:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 1
      - name: 生成版本号
        if: startsWith(github.ref, 'refs/tags/v')
        id: version_step
        run: |
          echo "##[set-output name=version_tag;]maodou38/${GITHUB_REPOSITORY#*/}:${GITHUB_REF#$"refs/tags/v"}"
          echo "##[set-output name=latest_tag;]maodou38/${GITHUB_REPOSITORY#*/}:latest"
      - name: 设置QEMU虚拟机
        uses: docker/setup-qemu-action@v2
      - name: 设置Docker Buildx
        uses: docker/setup-buildx-action@v1
      - name: 登陆DockerHub
        uses: docker/login-action@v2
        with:
            username: ${{ secrets.DOCKER_USER_NAME }}
            password: ${{ secrets.DOCKER_ACCESS_TOKEN }}
      - name: 准备镜像名称
        id: read-docker-image-identifiers
        run: |
            if [ -n "${{ steps.version_step.outputs.version_tag }}" ]; then
              echo VERSION_TAG=$(echo ${{ steps.version_step.outputs.version_tag }} | tr '[:upper:]' '[:lower:]') >> $GITHUB_ENV
              echo LATEST_TAG=$(echo ${{ steps.version_step.outputs.latest_tag  }} | tr '[:upper:]' '[:lower:]') >> $GITHUB_ENV
            else
              echo LATEST_TAG=maodou38/${GITHUB_REPOSITORY#*/}:latest >> $GITHUB_ENV
            fi
      - name: 构建Docker镜像
        run: |
          if [ -n "${{ env.VERSION_TAG }}" ]; then
            docker buildx build \
              --platform linux/amd64,linux/arm64,linux/arm/v7 \
              -t ${{ env.LATEST_TAG }} \
              -t ${{ env.VERSION_TAG }} \
              --push \
              .
          else
            docker buildx build \
              --platform linux/amd64,linux/arm64,linux/arm/v7 \
              -t ${{ env.LATEST_TAG }} \
              --push \
              .
          fi